;===========================================================
;파일명: STOCK.ERB
;주식 관련 정보 처리
;===========================================================
;주식시장 메인
;-----------------------------------------------------------
@STOCK_MARKET
#DIM STOCK_ID
#DIM PRICE_CODE

DRAWLINEFORM =
;CALL SHOW_STOCKSTORAGE
PRINTL 
$LOOP_STOCK
CALL SHOW_STOCKMARKET
INPUT
STOCK_ID = RESULT
SELECTCASE STOCK_ID
    CASE IS < MINIMUM_STOCKNO
        PRINTW 해당하는 종목코드가 없습니다.
        GOTO LOOP_STOCK
    CASE 999
        RETURN 0
    CASE IS > MAXIMUM_STOCKNO
        PRINTW 해당하는 종목코드가 없습니다.
        GOTO LOOP_STOCK
    CASEELSE
        PRICE_CODE = STOCK_ID - MINIMUM_STOCKNO
        PRINTFORMC TICKER: %ITEMNAME:STOCK_ID%
        IF STOCK_BOUGHT_PRICE:PRICE_CODE > 0
            MONEYSTR STOCK_BOUGHT_PRICE:PRICE_CODE
            PRINTFORMC 평균단가: %RESULTS%
        ENDIF
        PRINTFORMLC 소유 수: {ITEM:STOCK_ID}
        CALL STOCK_TRADE(STOCK_ID)
        GOTO LOOP_STOCK
ENDSELECT

;-----------------------------------------------------------
;주식 가격 처리
;ARG = STOCK_ID
;-----------------------------------------------------------
@SET_STOCKPRICE(ARG)
#FUNCTION
LOCAL = STOCK_PRICE:ARG
;주식 가격 첫설정시
SIF STOCK_PRICE:ARG == 0
    LOCAL += ITEMPRICE:ARG

LOCAL = (RAND(9223372036854775806) * LOCAL - LOCAL / 51 ) / 5
RETURNF LOCAL

;-----------------------------------------------------------
;주식 가격 업데이트 처리
;TODO 게임 내 시간당 변화할지 실제 시간당 변화할지 정해야함
;현재는 미변동
;-----------------------------------------------------------
@UPDATE_STOCK
#DIM STOCK_ID
#DIM PRICE_CODE

MAXIMUM_STOCKNO = MINIMUM_STOCKNO + STOCK_IN_MARKET - 1

FOR STOCK_ID, MINIMUM_STOCKNO, MAXIMUM_STOCKNO
    PRICE_CODE = (STOCK_ID - MINIMUM_STOCKNO)
    CALLF SET_STOCKPRICE(PRICE_CODE)
    STOCK_PRICE:PRICE_CODE = MAX(RESULT, ITEMPRICE:STOCK_ID)
NEXT

;-----------------------------------------------------------
;주식시장 현황 표시
;ITEMPRICE는 CSV에 적힌 최소값, STOCK_PRICE는 DIM으로 정의한 현 주식 가격 배열임
;-----------------------------------------------------------
@SHOW_STOCKMARKET
#DIM STOCK_ID
#DIM PRICE_CODE

DRAWLINEFORM =
FOR STOCK_ID, MINIMUM_STOCKNO, MAXIMUM_STOCKNO
    PRICE_CODE = (STOCK_ID - MINIMUM_STOCKNO)
    MONEYSTR STOCK_PRICE:PRICE_CODE
    PRINTL
    PRINTFORM [{STOCK_ID}] 
    PRINTFORMC %STR:STOCK_ID, 25, LEFT%
    PRINTFORMC 현재가: %RESULTS, 10%
    SIF ITEM:STOCK_ID > 0
        PRINTFORMC 잔고: {ITEM:STOCK_ID, 5} 주
NEXT
PRINTL
DRAWLINE
PRINTFORML [999] 돌아가기
DRAWLINEFORM =

;-----------------------------------------------------------
;주식 잔고 표시
;-----------------------------------------------------------
@SHOW_STOCKSTORAGE
PRINTW 미실장입니다.

;-----------------------------------------------------------
;주식 거래 함수
;ARG = STOCK_ID
;-----------------------------------------------------------
@STOCK_TRADE(ARG)
PRINTW 미실장입니다.
